@using Ktvg.Crm.ViewModels

@model IEnumerable<Ktvg.Crm.ViewModels.CustomerVM>
@{
    ViewData["Title"] = "Danh sách khách hàng";
    var message = TempData["CreateRegistrationSuccess"]?.ToString() ?? TempData["CreateRegistrationError"]?.ToString() ?? "";
}

<!-- Content wrapper -->
<div class="content-wrapper">
    <!-- Content -->

    <div class="container-xxl flex-grow-1 container-p-y">

        <!-- Basic Bootstrap Table -->
        <div class="card">
            <h5 class="card-header">
                <button class="btn btn-outline-primary waves-effect" 
                        data-bs-toggle="modal"
                        data-bs-target="#installRegistrationModal">
                    <i class="ri-add-circle-line"></i> &nbsp;Tạo mới
                </button>
                &nbsp;Khách hàng
            </h5>
            <div class="table-responsive text-nowrap">
                <table id="customerTable" class="table table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>
                                @Html.DisplayNameFor(model => model.CustomerSource)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.CustomerCode)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.CustomerName)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.PhoneNumber)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.CreatedDate)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Remark)
                            </th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody class="table-border-bottom-0">
                        @{
                            var index = 1;
                        }

                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>@(index++)</td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.CustomerSource)
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.CustomerCode)
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.CustomerName)
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.PhoneNumber)
                                </td>
                                <td>
                                    @item.CreatedDate.ToString("dd/MM/yyyy")
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.Remark)
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                                            <i class="ri-more-2-line"></i>
                                        </button>
                                        <div class="dropdown-menu">
                                            @foreach (var project in ViewBag.ProjectList)
                                            {
                                                <button class="dropdown-item project-button"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#contactHistoryModal"
                                                        data-project-id="@project.Id.ToString()"
                                                        data-project-name="@project.Name.ToString()"
                                                        data-customer-id="@item.Id.ToString()"
                                                        data-customer-name="@item.CustomerName.ToString()">
                                                    <i class="@project.Icon.ToString()"></i> @project.Name.ToString()
                                                </button>
                                            }
                                            <li><hr class="dropdown-divider"></li>
                                            <a asp-action="RecordContactHistory" asp-route-customerId="@item.Id" class="dropdown-item">
                                                <i class="ri-history-line"></i> Lịch sử tiếp xúc
                                            </a>
                                            <li><hr class="dropdown-divider"></li>
                                            <a class="dropdown-item" href="javascript:void(0);"><i class="ri-edit-2-line text-warning"></i> Sửa </a>
                                            <a class="dropdown-item" href="javascript:void(0);"><i class="ri-delete-bin-6-line text-danger"></i> Xóa</a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }

                    </tbody>
                </table>
            </div>
        </div>
        <!--/ Basic Bootstrap Table -->

    </div>
</div>

<!-- Gọi partial view trong View chính -->
@await Html.PartialAsync("_CustomerRegistrationModal", new CustomerVM())
@await Html.PartialAsync("_ContactHistoryModal", new ContactHistoryVM())

@section Scripts
{
    @* TODO: Cấu hình DataTable js *@
    @* <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script> *@
    @* <script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap5.min.js"></script> *@
    @* <script> *@
    @*     $(document).ready(function() { *@
    @*         $('#customerTable').DataTable({ *@
    @*             "language": { *@
    @*                 "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json" *@
    @*             } *@
    @*         }); *@
    @*     }); *@
    @* </script> *@

    <script>
        $(document).ready(function() {
            $('#contactHistoryModal').on('show.bs.modal', function() {
                $('.project-button').click(function() {
                    var projectId = $(this).data('project-id');
                    var projectName = $(this).data('project-name');
                    var customerId = $(this).data('customer-id');
                    var customerName = $(this).data('customer-name');

                    console.log("projectId: ", projectId);
                    console.log("projectName: ", projectName);
                    console.log("customerId: ", customerId);

                    $('#contactHistoryModalLabel').text(projectName + ": " + customerName);
                    $('#ContactProjectId').val(projectId);
                    $('#CustomerId').val(customerId);
                });
            });

            $('select[name="InstallationType"]').change(function () {

                console.log("paymentAmount:", $(this).val());
                var paymentAmount = $(this).val() === 'GPS' ? 960000 : 1980000;
                $('#PaymentAmount').val(paymentAmount);
            });

            // Prevent manual editing of CustomerCode
            $('#CustomerCode').on('input', function() {
                $(this).prop('readonly', true);
            });
        });

// Function to get the next customer code
        function getNextCustomerCode() {
            return $.ajax({
                url: '/Customers/GetNextCustomerCode',  // Kiểm tra URL có đúng không
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log("Success fetching customer code:", response);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching next customer code:', error);
                }
            });
        }

        $('#installRegistrationModal').on('show.bs.modal', function (event) {
            // Get today's date in YYYY-MM-DD format
            var today = new Date().toISOString().slice(0, 10);

            // Set default values
            $('#RegistrationDate').val(today);
            $('#CustomerName').val(''); // Clear any previous input
            $('#PhoneNumber').val('');
            $('#VehicleNumber').val('');
            $('#SendZaloConfirmation').prop('checked', true).val(true); // Check the checkbox
            $('#exampleFormControlTextarea1').val('');
            $('#PaymentAmount').val(960000);

// Gọi hàm getNextCustomerCode và xử lý kết quả
            getNextCustomerCode().then(function(response) {
                // Giả sử response trả về là { nextCode: "CUST-001" }

                console.log("nextCode: ", response);


                if (response && response.nextCode) {
                    
                    $('#CustomerCode').val(response.nextCode);
                } else {
                    console.error('Invalid response:', response);
                }
            }).catch(function(error) {
                console.error('Error in AJAX request:', error);
            });
        });

        $('#installRegistrationModal').find('.btn-primary').click(function () {
            var isValid = true;
            var errorMessage = "";

            // Kiểm tra các trường bắt buộc
            $('#installRegistrationModal .modal-body :input[required]').each(function () {
                if ($(this).val() === '') {
                    isValid = false;
                    errorMessage += "Vui lòng nhập " + $(this).prev('label').text().trim() + "\n";
                }
            });

            // Kiểm tra định dạng số điện thoại (ví dụ: chỉ cho phép số)
            var PhoneNumber = $('#PhoneNumber').val();
            if (!/^\d+$/.test(PhoneNumber)) {
                isValid = false;
                errorMessage += "Số điện thoại không hợp lệ. Vui lòng chỉ nhập số.\n";
            }

            // Kiểm tra số tiền thanh toán (nếu có nhập) là số dương
            var PaymentAmount = $('#PaymentAmount').val();
            if (PaymentAmount !== '' && (!$.isNumeric(PaymentAmount) || parseFloat(PaymentAmount) < 0)) {
                isValid = false;
                errorMessage += "Số tiền thanh toán phải là số dương.\n";
            }

            if (isValid) {
                // Nếu tất cả các trường hợp lệ, bạn có thể gửi dữ liệu đi hoặc thực hiện các hành động khác ở đây
                // alert("Dữ liệu đã được xác thực và sẵn sàng để lưu!");
            } else {
                event.preventDefault(); // Chặn không cho thực hiện submit form
                alert(errorMessage);
            }
        });

        const $sendZaloCheckbox = $('#SendZaloConfirmation');

        $sendZaloCheckbox.change(function () {
            $(this).val(!$(this).is(':checked'));
        });

        $('input[name="LocateType"]').change(function () {
            var paymentAmount = $(this).val() === '1' ? 0 : 960000;
            $('#PaymentAmount').val(paymentAmount);
        });

        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const customerCheckboxes = document.querySelectorAll('input[name="selectedCustomers"]');

        // Bắt sự kiện click cho checkbox có class 'selectedCustomers'
        $('.selectedCustomers').on('click', function () {
            var selectedCustomerIds = [];
            $("input[name='selectedCustomers']:checked").each(function () {
                selectedCustomerIds.push($(this).val());
            });

            $("#sendSmsButton").text(selectedCustomerIds.length === 0 ? "Nhắc nhở gia hạn" : "Nhắc nhở gia hạn (" + selectedCustomerIds.length + ")");
        });

    </script>
}
 